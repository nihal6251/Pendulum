{"version":3,"file":"canvas-sprite.min.mjs","sources":["../../src/CanvasSpriteRenderer.ts","../../src/Sprite.ts"],"sourcesContent":["import { SCALE_MODES, BLEND_MODES } from '@pixi/constants';\nimport { Matrix, groupD8 } from '@pixi/math';\nimport { canvasUtils } from '@pixi/canvas-renderer';\nimport type { CanvasRenderer } from '@pixi/canvas-renderer';\nimport type { Sprite } from '@pixi/sprite';\nimport type { ExtensionMetadata } from '@pixi/core';\nimport { ExtensionType } from '@pixi/core';\n\nconst canvasRenderWorldTransform = new Matrix();\n\n/**\n * Types that can be passed to drawImage\n * @typedef {HTMLImageElement | HTMLCanvasElement | HTMLVideoElement | ImageBitmap} ICanvasImageSource\n * @memberof PIXI\n */\n\n/*\n * @author Mat Groves\n *\n * Big thanks to the very clever Matt DesLauriers <mattdesl> https://github.com/mattdesl/\n * for creating the original PixiJS version!\n * Also a thanks to https://github.com/bchevalier for tweaking the tint and alpha so that they now\n * share 4 bytes on the vertex buffer\n *\n * Heavily inspired by LibGDX's CanvasSpriteRenderer:\n * https://github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/graphics/g2d/CanvasSpriteRenderer.java\n */\n\n/**\n * Renderer dedicated to drawing and batching sprites.\n * @class\n * @protected\n * @memberof PIXI\n */\nexport class CanvasSpriteRenderer\n{\n    /** @ignore */\n    static extension: ExtensionMetadata = {\n        name: 'sprite',\n        type: ExtensionType.CanvasRendererPlugin,\n    };\n\n    /** A reference to the current renderer */\n    protected renderer: CanvasRenderer;\n\n    /** @param renderer - A reference to the current renderer */\n    constructor(renderer: CanvasRenderer)\n    {\n        this.renderer = renderer;\n    }\n\n    /**\n     * Renders the sprite object.\n     * @param sprite - the sprite to render when using this spritebatch\n     */\n    render(sprite: Sprite): void\n    {\n        const texture = sprite._texture;\n        const renderer = this.renderer;\n        const context = renderer.context;\n\n        if (!texture.valid)\n        {\n            return;\n        }\n\n        const sourceWidth = texture._frame.width;\n        const sourceHeight = texture._frame.height;\n\n        let destWidth = texture._frame.width;\n        let destHeight = texture._frame.height;\n\n        if (texture.trim)\n        {\n            if (groupD8.isVertical(texture.rotate))\n            {\n                destWidth = texture.trim.height;\n                destHeight = texture.trim.width;\n            }\n            else\n            {\n                destWidth = texture.trim.width;\n                destHeight = texture.trim.height;\n            }\n        }\n\n        let wt = sprite.transform.worldTransform;\n        let dx = 0;\n        let dy = 0;\n\n        const source = texture.baseTexture.getDrawableSource();\n\n        if (texture.orig.width <= 0 || texture.orig.height <= 0 || !texture.valid || !source)\n        {\n            return;\n        }\n\n        renderer.setBlendMode(sprite.blendMode, true);\n\n        renderer.context.globalAlpha = sprite.worldAlpha;\n\n        // If smoothingEnabled is supported and we need to change the smoothing property for sprite texture\n        const smoothingEnabled = texture.baseTexture.scaleMode === SCALE_MODES.LINEAR;\n\n        if (renderer.smoothProperty\n            && renderer.context[renderer.smoothProperty] !== smoothingEnabled)\n        {\n            context[renderer.smoothProperty] = smoothingEnabled;\n        }\n\n        if (texture.trim)\n        {\n            dx = (texture.trim.width / 2) + texture.trim.x - (sprite.anchor.x * texture.orig.width);\n            dy = (texture.trim.height / 2) + texture.trim.y - (sprite.anchor.y * texture.orig.height);\n        }\n        else\n        {\n            dx = (0.5 - sprite.anchor.x) * texture.orig.width;\n            dy = (0.5 - sprite.anchor.y) * texture.orig.height;\n        }\n\n        if (texture.rotate)\n        {\n            wt.copyTo(canvasRenderWorldTransform);\n            wt = canvasRenderWorldTransform;\n            groupD8.matrixAppendRotationInv(wt, texture.rotate, dx, dy);\n            // the anchor has already been applied above, so lets set it to zero\n            dx = 0;\n            dy = 0;\n        }\n\n        dx -= destWidth / 2;\n        dy -= destHeight / 2;\n\n        renderer.setContextTransform(wt, sprite.roundPixels, 1);\n        // Allow for pixel rounding\n        if (sprite.roundPixels)\n        {\n            dx = dx | 0;\n            dy = dy | 0;\n        }\n\n        const resolution = texture.baseTexture.resolution;\n        const outerBlend = renderer._outerBlend;\n\n        if (outerBlend)\n        {\n            context.save();\n            context.beginPath();\n            context.rect(\n                dx * renderer.resolution,\n                dy * renderer.resolution,\n                destWidth * renderer.resolution,\n                destHeight * renderer.resolution\n            );\n            context.clip();\n        }\n\n        if (sprite.tint !== 0xFFFFFF)\n        {\n            if (sprite._cachedTint !== sprite.tint || sprite._tintedCanvas.tintId !== sprite._texture._updateID)\n            {\n                sprite._cachedTint = sprite.tint;\n\n                // TODO clean up caching - how to clean up the caches?\n                sprite._tintedCanvas = canvasUtils.getTintedCanvas(sprite, sprite.tint);\n            }\n\n            context.drawImage(\n                sprite._tintedCanvas,\n                0,\n                0,\n                Math.floor(sourceWidth * resolution),\n                Math.floor(sourceHeight * resolution),\n                Math.floor(dx * renderer.resolution),\n                Math.floor(dy * renderer.resolution),\n                Math.floor(destWidth * renderer.resolution),\n                Math.floor(destHeight * renderer.resolution)\n            );\n        }\n        else\n        {\n            context.drawImage(\n                source,\n                texture._frame.x * resolution,\n                texture._frame.y * resolution,\n                Math.floor(sourceWidth * resolution),\n                Math.floor(sourceHeight * resolution),\n                Math.floor(dx * renderer.resolution),\n                Math.floor(dy * renderer.resolution),\n                Math.floor(destWidth * renderer.resolution),\n                Math.floor(destHeight * renderer.resolution)\n            );\n        }\n\n        if (outerBlend)\n        {\n            context.restore();\n        }\n        // just in case, leaking outer blend here will be catastrophic!\n        renderer.setBlendMode(BLEND_MODES.NORMAL);\n    }\n\n    /** destroy the sprite object */\n    destroy(): void\n    {\n        this.renderer = null;\n    }\n}\n","import { Sprite } from '@pixi/sprite';\nimport type { CanvasRenderer } from '@pixi/canvas-renderer';\n\n/**\n * Cached tinted texture.\n * @memberof PIXI.Sprite#\n * @member {HTMLCanvasElement} _tintedCanvas\n * @protected\n */\nSprite.prototype._tintedCanvas = null;\n\n/**\n * Renders the object using the Canvas renderer\n * @private\n * @method _renderCanvas\n * @memberof PIXI.Sprite#\n * @param {PIXI.CanvasRenderer} renderer - The renderer\n */\nSprite.prototype._renderCanvas = function _renderCanvas(renderer: CanvasRenderer): void\n{\n    renderer.plugins.sprite.render(this);\n};\n"],"names":["canvasRenderWorldTransform","Matrix","CanvasSpriteRenderer","renderer","this","prototype","render","sprite","texture","_texture","context","valid","sourceWidth","_frame","width","sourceHeight","height","destWidth","destHeight","trim","groupD8","isVertical","rotate","wt","transform","worldTransform","dx","dy","source","baseTexture","getDrawableSource","orig","setBlendMode","blendMode","globalAlpha","worldAlpha","smoothingEnabled","scaleMode","SCALE_MODES","LINEAR","smoothProperty","x","anchor","y","copyTo","matrixAppendRotationInv","setContextTransform","roundPixels","resolution","outerBlend","_outerBlend","save","beginPath","rect","clip","tint","_cachedTint","_tintedCanvas","tintId","_updateID","canvasUtils","getTintedCanvas","drawImage","Math","floor","restore","BLEND_MODES","NORMAL","destroy","extension","name","type","ExtensionType","CanvasRendererPlugin","Sprite","_renderCanvas","plugins"],"mappings":"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"}